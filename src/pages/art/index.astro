---
import type { CollectionEntry } from 'astro:content'
import ArtworkGrid from '@/components/ArtworkGrid.astro'
import Container from '@/components/layout/Container.astro'
import Subheader from '@/components/layout/Subheader.astro'
import { ARTWORK } from '@/consts'
import PageLayout from '@/layouts/PageLayout.astro'
import { artworkTypes } from '@content/config'
import { getCollection } from 'astro:content'

// optimize artwork data processing
const artworks = (await getCollection('artwork'))
  .filter((artwork: CollectionEntry<'artwork'>) => !artwork.data.draft)
  .sort((a: CollectionEntry<'artwork'>, b: CollectionEntry<'artwork'>) =>
    b.data.date.valueOf() - a.data.date.valueOf(),
  )

// create an optimized data structure for year-based organization
const artworkData = {
  years: new Set<number>(),
  byYear: new Map<number, CollectionEntry<'artwork'>[]>(),
}

// single pass through the data
artworks.forEach((artwork: CollectionEntry<'artwork'>) => {
  const year = artwork.data.date.getFullYear()

  // track years
  artworkData.years.add(year)

  // add to year mapping
  if (!artworkData.byYear.has(year)) {
    artworkData.byYear.set(year, [])
  }
  artworkData.byYear.get(year)!.push(artwork)
})

const allYears = [...artworkData.years].sort((a, b) => b - a)
const categories = ['all', ...artworkTypes] as const
---

<PageLayout title={ARTWORK.TITLE} description={ARTWORK.DESCRIPTION}>
  <Container>
    <div class="space-y-12 animate">

      <!-- page header -->
      <Subheader title="Art" subtitle="my archived artwork" categories={categories} />

      <!-- image gallery -->
      <div class="gallery-container">
        {allYears.map(year => (
          <div class="year-section" data-year={year}>
            <div class="divider divider-start text-base-content/50 font-medium my-8 animate">{year}</div>
            <ArtworkGrid artworks={artworkData.byYear.get(year) || []} />
          </div>
        ))}
      </div>

    </div>
  </Container>
</PageLayout>

<style>
.year-section:empty {
  display: none;
}
</style>
